<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2196F3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Organizzatore Settimanale v2.0</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk9yZ2FuaXp6YXRvcmUgU2V0dGltYW5hbGUgdjIiLAogICJzaG9ydF9uYW1lIjogIlBsYW5uZXIiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiMyMTk2RjMiCn0=">
    <style>
        :root {
            --primary: #2196F3;
            --primary-dark: #1976D2;
            --bg-light: #f5f5f5;
            --bg-white: #ffffff;
            --text-dark: #333333;
            --text-muted: #666666;
            --text-light: #999999;
            --border: #e0e0e0;
            --shadow: rgba(0,0,0,0.1);
            --event-bg: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            --event-border: #2196F3;

            /* Category colors */
            --cat-work: #2196F3;
            --cat-personal: #9C27B0;
            --cat-health: #4CAF50;
            --cat-meeting: #FF9800;
            --cat-urgent: #f44336;
        }

        .dark-mode {
            --primary: #64B5F6;
            --primary-dark: #42A5F5;
            --bg-light: #1a1a2e;
            --bg-white: #16213e;
            --text-dark: #e0e0e0;
            --text-muted: #b0b0b0;
            --text-light: #808080;
            --border: #2a2a4a;
            --shadow: rgba(0,0,0,0.3);
            --event-bg: linear-gradient(135deg, #1a365d 0%, #2a4a7f 100%);
            --event-border: #64B5F6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            overflow: hidden;
            touch-action: pan-y;
            height: 100vh;
            transition: background 0.3s;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 10px 16px 6px 16px;
            text-align: center;
            box-shadow: 0 4px 12px var(--shadow);
            position: relative;
            z-index: 10;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            gap: 8px;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .header-btn:active {
            background: rgba(255,255,255,0.3);
            transform: scale(0.95);
        }

        .date-display {
            font-size: 14px;
            font-weight: bold;
            flex: 1;
            white-space: nowrap;
            overflow: visible;
            text-align: center;
        }

        .days-scroll {
            display: flex;
            overflow-x: auto;
            gap: 4px;
            padding: 6px 0;
            margin: 0 -16px;
            padding-left: 16px;
            padding-right: 16px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .days-scroll::-webkit-scrollbar {
            display: none;
        }

        .day-chip {
            flex-shrink: 0;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-width: 50px;
        }

        .day-chip.active {
            background: white;
            color: var(--primary);
            border-color: white;
        }

        .day-chip.has-events {
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
        }

        .day-chip:active {
            transform: scale(0.95);
        }

        .container {
            position: relative;
            height: calc(100vh - 105px);
            overflow: hidden;
            perspective: 1000px;
        }

        .day-view {
            position: absolute;
            width: 94%;
            left: 3%;
            height: calc(100% - 30px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: transform, opacity;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow);
            background: var(--bg-light);
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            padding: 2px 0;
        }

        .day-view::-webkit-scrollbar {
            width: 4px;
        }

        .day-view::-webkit-scrollbar-track {
            background: transparent;
        }

        .day-view::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 2px;
        }

        .day-view.no-transition {
            transition: none;
        }

        .day-view.left {
            transform: translateX(-105%) scale(0.9);
            opacity: 0.5;
        }

        .day-view.center {
            transform: translateX(0) scale(1);
            opacity: 1;
            z-index: 10;
        }

        .day-view.right {
            transform: translateX(105%) scale(0.9);
            opacity: 0.5;
        }

        .current-time-indicator {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: #f44336;
            z-index: 100;
            pointer-events: none;
        }

        .current-time-indicator::before {
            content: '';
            position: absolute;
            left: 0;
            top: -4px;
            width: 10px;
            height: 10px;
            background: #f44336;
            border-radius: 50%;
        }

        .current-time-indicator::after {
            content: attr(data-time);
            position: absolute;
            right: 4px;
            top: -8px;
            font-size: 9px;
            color: #f44336;
            font-weight: bold;
            background: var(--bg-white);
            padding: 1px 4px;
            border-radius: 4px;
        }

        .swipe-indicator {
            position: fixed;
            bottom: 6px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 4px;
            z-index: 1000;
            pointer-events: none;
            background: var(--bg-white);
            padding: 3px 8px;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .swipe-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: rgba(33, 150, 243, 0.3);
            transition: all 0.3s;
        }

        .swipe-dot.active {
            width: 16px;
            border-radius: 3px;
            background: var(--primary);
        }

        .hour-slot {
            background: var(--bg-white);
            margin: 1px 4px;
            padding: 2px 6px;
            border-radius: 4px;
            box-shadow: 0 1px 2px var(--shadow);
            display: flex;
            align-items: center;
            min-height: 28px;
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
            touch-action: manipulation;
            position: relative;
            border-left: 3px solid transparent;
        }

        .hour-slot:active {
            transform: scale(0.98);
        }

        .hour-slot.half-hour {
            min-height: 24px;
            opacity: 0.9;
        }

        .hour-slot.half-hour .hour-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        .hour-time {
            font-weight: bold;
            font-size: 12px;
            color: var(--primary);
            min-width: 42px;
        }

        .event-content {
            flex: 1;
            margin-left: 6px;
            overflow: hidden;
        }

        .event-title {
            font-weight: 600;
            font-size: 12px;
            color: var(--text-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .event-description {
            font-size: 9px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.1;
        }

        .event-duration {
            font-size: 8px;
            color: var(--text-light);
            margin-left: 4px;
        }

        .share-btn {
            background: none;
            border: none;
            font-size: 14px;
            cursor: pointer;
            padding: 2px 4px;
            opacity: 0.6;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .share-btn:active {
            opacity: 1;
            transform: scale(1.2);
        }

        .hour-slot.has-event {
            background: var(--event-bg);
            border-left-color: var(--event-border);
        }

        /* Category colors */
        .hour-slot.cat-work { border-left-color: var(--cat-work); }
        .hour-slot.cat-personal { border-left-color: var(--cat-personal); }
        .hour-slot.cat-health { border-left-color: var(--cat-health); }
        .hour-slot.cat-meeting { border-left-color: var(--cat-meeting); }
        .hour-slot.cat-urgent { border-left-color: var(--cat-urgent); }

        .hour-slot.event-continues {
            background: var(--event-bg);
            opacity: 0.7;
            border-left-style: dashed;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.2s;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--bg-white);
            border-radius: 12px;
            padding: 20px;
            width: 92%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 16px;
            color: var(--text-dark);
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-muted);
            font-size: 13px;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--bg-white);
            color: var(--text-dark);
        }

        .input-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .input-row {
            display: flex;
            gap: 10px;
        }

        .input-row .input-group {
            flex: 1;
        }

        .category-picker {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .category-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-btn:hover {
            transform: scale(1.1);
        }

        .category-btn.active {
            border-color: var(--text-dark);
            box-shadow: 0 0 0 2px var(--bg-white);
        }

        .category-btn.cat-work { background: var(--cat-work); }
        .category-btn.cat-personal { background: var(--cat-personal); }
        .category-btn.cat-health { background: var(--cat-health); }
        .category-btn.cat-meeting { background: var(--cat-meeting); }
        .category-btn.cat-urgent { background: var(--cat-urgent); }

        .modal-buttons {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:active {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-muted);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-calendar {
            background: #34A853;
            color: white;
            margin-top: 10px;
            width: 100%;
        }

        .checkbox-group {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-muted);
            cursor: pointer;
        }

        .checkbox-label input {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .empty-state {
            color: var(--text-light);
            font-size: 10px;
        }

        .version-badge {
            font-size: 9px;
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 8px;
            margin-left: 8px;
        }

        /* Stats bar */
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 4px 0;
            font-size: 10px;
            color: rgba(255,255,255,0.8);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <button class="header-btn" onclick="goToToday()">üìÖ Oggi</button>
            <div class="date-display" id="dateDisplay">
                Caricamento...
                <span class="version-badge">v2.0</span>
            </div>
            <button class="header-btn" onclick="toggleDarkMode()">üåô</button>
        </div>
        <div class="stats-bar">
            <div class="stat-item"><span>üìä</span> <span id="todayEvents">0</span> eventi oggi</div>
            <div class="stat-item"><span>‚è∞</span> <span id="nextEvent">--:--</span></div>
        </div>
        <div class="days-scroll" id="daysScroll"></div>
    </div>

    <div class="container" id="container">
        <div class="day-view center" id="currentDay"></div>
        <div class="day-view right" id="nextDay"></div>
        <div class="day-view left" id="prevDay"></div>
    </div>

    <div class="swipe-indicator">
        <div class="swipe-dot"></div>
        <div class="swipe-dot active"></div>
        <div class="swipe-dot"></div>
    </div>

    <div class="modal" id="eventModal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">Aggiungi Evento</div>

            <div class="input-group">
                <label for="eventTitle">Titolo *</label>
                <input type="text" id="eventTitle" placeholder="Es: Riunione di lavoro">
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label for="eventDuration">Durata</label>
                    <select id="eventDuration">
                        <option value="30">30 minuti</option>
                        <option value="60" selected>1 ora</option>
                        <option value="90">1 ora 30 min</option>
                        <option value="120">2 ore</option>
                        <option value="180">3 ore</option>
                        <option value="240">4 ore</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Categoria</label>
                    <div class="category-picker">
                        <button type="button" class="category-btn cat-work active" data-cat="work" title="Lavoro"></button>
                        <button type="button" class="category-btn cat-personal" data-cat="personal" title="Personale"></button>
                        <button type="button" class="category-btn cat-health" data-cat="health" title="Salute"></button>
                        <button type="button" class="category-btn cat-meeting" data-cat="meeting" title="Meeting"></button>
                        <button type="button" class="category-btn cat-urgent" data-cat="urgent" title="Urgente"></button>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label for="eventDescription">Note (opzionale)</label>
                <textarea id="eventDescription" placeholder="Dettagli aggiuntivi..."></textarea>
            </div>

            <div class="checkbox-group" id="newEventOptions">
                <label class="checkbox-label">
                    <input type="checkbox" id="addToCalendar" checked>
                    <span>üìÖ Aggiungi a Google Calendar</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="repeatDaily">
                    <span>üîÅ Ripeti ogni giorno</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="repeatWeekly">
                    <span>üìÜ Ripeti ogni settimana</span>
                </label>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal()">Annulla</button>
                <button class="btn btn-danger" id="deleteBtn" style="display:none;" onclick="deleteEvent()">üóëÔ∏è</button>
                <button class="btn btn-primary" onclick="saveEvent()">üíæ Salva</button>
            </div>

            <button class="btn btn-calendar" id="calendarBtn" style="display:none;" onclick="addExistingToCalendar()">
                üìÖ Apri in Google Calendar
            </button>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        let currentSlot = null;
        let selectedCategory = 'work';
        let touchStartX = 0;
        let touchEndX = 0;
        let isSwiping = false;
        let deferredPrompt;

        const container = document.getElementById('container');
        const currentDayEl = document.getElementById('currentDay');
        const nextDayEl = document.getElementById('nextDay');
        const prevDayEl = document.getElementById('prevDay');

        // Time slots: 7:00 to 21:30 with 30-minute intervals
        const TIME_SLOTS = [];
        for (let hour = 7; hour <= 21; hour++) {
            TIME_SLOTS.push({ hour, minute: 0 });
            if (hour < 21) {
                TIME_SLOTS.push({ hour, minute: 30 });
            }
        }

        // Dark mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        // Load dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }

        // Category picker
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedCategory = btn.dataset.cat;
            });
        });

        // Service Worker
        if ('serviceWorker' in navigator) {
            const swCode = `
                self.addEventListener('install', (e) => {
                    e.waitUntil(caches.open('planner-v2').then(cache => cache.addAll(['/'])));
                });
                self.addEventListener('fetch', (e) => {
                    e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
                });
            `;
            const blob = new Blob([swCode], { type: 'application/javascript' });
            navigator.serviceWorker.register(URL.createObjectURL(blob));
        }

        // Storage functions
        function getSlotKey(hour, minute) {
            return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
        }

        function getEvents(date) {
            const key = formatDate(date);
            const stored = localStorage.getItem(`events_${key}`);
            const dayEvents = stored ? JSON.parse(stored) : {};

            // Add recurring events
            const recurring = getRecurringEvents();
            for (let id in recurring) {
                const rec = recurring[id];
                const startDate = new Date(rec.startDate);
                const checkDate = new Date(date);
                checkDate.setHours(0,0,0,0);
                startDate.setHours(0,0,0,0);

                if (checkDate >= startDate) {
                    // Check if it's weekly and matches the day of week
                    if (rec.repeatType === 'weekly') {
                        if (checkDate.getDay() !== startDate.getDay()) continue;
                    }

                    const slotKey = rec.slotKey;
                    if (!dayEvents[slotKey]) {
                        dayEvents[slotKey] = {
                            ...rec,
                            isRecurring: true,
                            recurringId: id
                        };
                    }
                }
            }

            return dayEvents;
        }

        function getRecurringEvents() {
            const stored = localStorage.getItem('recurring_events_v2');
            return stored ? JSON.parse(stored) : {};
        }

        function saveEvent(date, slotKey, event) {
            const key = formatDate(date);
            const events = {};
            const stored = localStorage.getItem(`events_${key}`);
            if (stored) Object.assign(events, JSON.parse(stored));
            events[slotKey] = event;
            localStorage.setItem(`events_${key}`, JSON.stringify(events));
        }

        function saveRecurringEvent(slotKey, event, repeatType) {
            const recurring = getRecurringEvents();
            const id = `${slotKey}_${Date.now()}`;
            recurring[id] = {
                ...event,
                slotKey,
                startDate: formatDate(currentDate),
                repeatType
            };
            localStorage.setItem('recurring_events_v2', JSON.stringify(recurring));
        }

        function deleteEventFromStorage(date, slotKey) {
            const key = formatDate(date);
            const stored = localStorage.getItem(`events_${key}`);
            if (stored) {
                const events = JSON.parse(stored);
                delete events[slotKey];
                localStorage.setItem(`events_${key}`, JSON.stringify(events));
            }
        }

        function removeRecurringEvent(recurringId) {
            const recurring = getRecurringEvents();
            delete recurring[recurringId];
            localStorage.setItem('recurring_events_v2', JSON.stringify(recurring));
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function formatDateDisplay(date) {
            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            return date.toLocaleDateString('it-IT', options);
        }

        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function renderDay(date, container) {
            const events = getEvents(date);
            let html = '';
            const now = new Date();
            const showTimeIndicator = isToday(date);

            // Calculate slots that are continuations of previous events
            const continuationSlots = {};
            for (let slotKey in events) {
                const event = events[slotKey];
                if (event && event.duration > 30) {
                    const [h, m] = slotKey.split(':').map(Number);
                    let slots = Math.floor(event.duration / 30) - 1;
                    let currentH = h;
                    let currentM = m;

                    for (let i = 0; i < slots; i++) {
                        currentM += 30;
                        if (currentM >= 60) {
                            currentM = 0;
                            currentH++;
                        }
                        const contKey = getSlotKey(currentH, currentM);
                        continuationSlots[contKey] = { parentKey: slotKey, event };
                    }
                }
            }

            TIME_SLOTS.forEach(slot => {
                const slotKey = getSlotKey(slot.hour, slot.minute);
                const event = events[slotKey];
                const continuation = continuationSlots[slotKey];
                const hasEvent = event && event.title;
                const isHalfHour = slot.minute === 30;
                const timeStr = slotKey;

                // Current time indicator position
                let timeIndicator = '';
                if (showTimeIndicator) {
                    const slotStart = slot.hour * 60 + slot.minute;
                    const slotEnd = slotStart + 30;
                    const currentMinutes = now.getHours() * 60 + now.getMinutes();

                    if (currentMinutes >= slotStart && currentMinutes < slotEnd) {
                        const offset = ((currentMinutes - slotStart) / 30) * 100;
                        const timeNow = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
                        timeIndicator = `<div class="current-time-indicator" style="top: ${offset}%;" data-time="${timeNow}"></div>`;
                    }
                }

                let slotClasses = `hour-slot ${isHalfHour ? 'half-hour' : ''}`;
                let content = '';

                if (continuation) {
                    slotClasses += ` event-continues cat-${continuation.event.category || 'work'}`;
                    content = `<div class="event-content"><div class="event-title" style="opacity:0.5">‚Ü≥ ${continuation.event.title}</div></div>`;
                } else if (hasEvent) {
                    slotClasses += ` has-event cat-${event.category || 'work'}`;
                    const durationText = event.duration > 30 ? `<span class="event-duration">${event.duration}min</span>` : '';
                    content = `
                        <div class="event-content">
                            <div class="event-title">
                                ${event.isRecurring ? 'üîÅ ' : ''}${event.title}${durationText}
                            </div>
                            ${event.description ? `<div class="event-description">${event.description}</div>` : ''}
                        </div>
                        <button class="share-btn" onclick="event.stopPropagation(); shareEvent('${slotKey}')">üì§</button>
                    `;
                } else {
                    content = `<div class="event-content"><div class="empty-state">‚Äî</div></div>`;
                }

                html += `
                    <div class="${slotClasses}" onclick="openModal('${slotKey}')" style="position:relative;">
                        ${timeIndicator}
                        <div class="hour-time">${timeStr}</div>
                        ${content}
                    </div>
                `;
            });

            container.innerHTML = html;

            // Scroll to current time
            if (showTimeIndicator) {
                setTimeout(() => {
                    const indicator = container.querySelector('.current-time-indicator');
                    if (indicator) {
                        indicator.parentElement.scrollIntoView({ block: 'center', behavior: 'smooth' });
                    }
                }, 100);
            }
        }

        function updateDisplay() {
            document.getElementById('dateDisplay').innerHTML = formatDateDisplay(currentDate) + '<span class="version-badge">v2.0</span>';

            renderDay(currentDate, currentDayEl);

            const nextDate = new Date(currentDate);
            nextDate.setDate(nextDate.getDate() + 1);
            renderDay(nextDate, nextDayEl);

            const prevDate = new Date(currentDate);
            prevDate.setDate(prevDate.getDate() - 1);
            renderDay(prevDate, prevDayEl);

            renderDaysScroll();
            updateStats();
        }

        function updateStats() {
            const events = getEvents(currentDate);
            const eventCount = Object.values(events).filter(e => e && e.title).length;
            document.getElementById('todayEvents').textContent = eventCount;

            // Find next event
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            let nextEventTime = '--:--';

            if (isToday(currentDate)) {
                for (let slot of TIME_SLOTS) {
                    const slotKey = getSlotKey(slot.hour, slot.minute);
                    const slotMinutes = slot.hour * 60 + slot.minute;
                    if (slotMinutes > currentMinutes && events[slotKey] && events[slotKey].title) {
                        nextEventTime = slotKey;
                        break;
                    }
                }
            }
            document.getElementById('nextEvent').textContent = nextEventTime;
        }

        function renderDaysScroll() {
            const scrollContainer = document.getElementById('daysScroll');
            let html = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = -7; i < 30; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);

                const dayName = date.toLocaleDateString('it-IT', { weekday: 'short' });
                const dayNum = date.getDate();

                const currentNorm = new Date(currentDate);
                currentNorm.setHours(0, 0, 0, 0);
                const isActive = date.getTime() === currentNorm.getTime();

                // Check if day has events
                const dayEvents = getEvents(date);
                const hasEvents = Object.values(dayEvents).some(e => e && e.title);

                html += `
                    <div class="day-chip ${isActive ? 'active' : ''} ${hasEvents ? 'has-events' : ''}"
                         onclick="jumpToDate('${date.toISOString()}')">
                        <div style="font-size: 8px; opacity: 0.8;">${dayName}</div>
                        <div style="font-weight: 700;">${dayNum}</div>
                    </div>
                `;
            }

            scrollContainer.innerHTML = html;

            setTimeout(() => {
                const activeChip = scrollContainer.querySelector('.day-chip.active');
                if (activeChip) {
                    activeChip.scrollIntoView({ inline: 'center', behavior: 'smooth' });
                }
            }, 100);
        }

        function jumpToDate(isoDate) {
            currentDate = new Date(isoDate);
            updateDisplay();
        }

        function goToToday() {
            currentDate = new Date();
            updateDisplay();
        }

        function changeDay(offset) {
            currentDate.setDate(currentDate.getDate() + offset);
            updateDisplay();
        }

        function openModal(slotKey) {
            currentSlot = slotKey;
            const events = getEvents(currentDate);
            const event = events[slotKey];

            document.getElementById('modalTitle').textContent = event ? 'Modifica Evento' : 'Nuovo Evento alle ' + slotKey;
            document.getElementById('eventTitle').value = event ? event.title : '';
            document.getElementById('eventDescription').value = event ? (event.description || '') : '';
            document.getElementById('eventDuration').value = event ? (event.duration || 60) : 60;

            // Set category
            selectedCategory = event ? (event.category || 'work') : 'work';
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.cat === selectedCategory);
            });

            document.getElementById('deleteBtn').style.display = event ? 'block' : 'none';
            document.getElementById('calendarBtn').style.display = event ? 'block' : 'none';
            document.getElementById('newEventOptions').style.display = event ? 'none' : 'block';

            // Reset checkboxes
            document.getElementById('addToCalendar').checked = true;
            document.getElementById('repeatDaily').checked = false;
            document.getElementById('repeatWeekly').checked = false;

            document.getElementById('eventModal').classList.add('show');
            document.getElementById('eventTitle').focus();
        }

        function closeModal() {
            document.getElementById('eventModal').classList.remove('show');
            currentSlot = null;
        }

        function saveEventHandler() {
            const title = document.getElementById('eventTitle').value.trim();
            if (!title) {
                alert('Inserisci un titolo');
                return;
            }

            const description = document.getElementById('eventDescription').value.trim();
            const duration = parseInt(document.getElementById('eventDuration').value);
            const addToCal = document.getElementById('addToCalendar').checked;
            const repeatDaily = document.getElementById('repeatDaily').checked;
            const repeatWeekly = document.getElementById('repeatWeekly').checked;

            const eventData = {
                title,
                description,
                duration,
                category: selectedCategory
            };

            saveEvent(currentDate, currentSlot, eventData);

            if (repeatDaily) {
                saveRecurringEvent(currentSlot, eventData, 'daily');
            } else if (repeatWeekly) {
                saveRecurringEvent(currentSlot, eventData, 'weekly');
            }

            if (addToCal) {
                openGoogleCalendar(title, description, currentDate, currentSlot, duration);
            }

            updateDisplay();
            closeModal();
        }

        // Override the button onclick
        document.querySelector('.btn-primary').onclick = saveEventHandler;

        function openGoogleCalendar(title, description, date, slotKey, duration) {
            const [hour, minute] = slotKey.split(':').map(Number);
            const startDate = new Date(date);
            startDate.setHours(hour, minute, 0, 0);

            const endDate = new Date(startDate);
            endDate.setMinutes(endDate.getMinutes() + duration);

            const formatGoogleDate = (d) => {
                return d.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
            };

            const params = new URLSearchParams({
                action: 'TEMPLATE',
                text: title,
                details: description,
                dates: `${formatGoogleDate(startDate)}/${formatGoogleDate(endDate)}`
            });

            window.open(`https://calendar.google.com/calendar/render?${params}`, '_blank');
        }

        function addExistingToCalendar() {
            const events = getEvents(currentDate);
            const event = events[currentSlot];
            if (event) {
                openGoogleCalendar(event.title, event.description || '', currentDate, currentSlot, event.duration || 60);
            }
        }

        function deleteEvent() {
            const events = getEvents(currentDate);
            const event = events[currentSlot];

            if (event && event.isRecurring) {
                const deleteAll = confirm('Evento ripetuto.\n\nOK = Elimina TUTTA LA SERIE\nAnnulla = Solo oggi');
                if (deleteAll) {
                    removeRecurringEvent(event.recurringId);
                } else {
                    deleteEventFromStorage(currentDate, currentSlot);
                }
            } else {
                if (confirm('Eliminare questo evento?')) {
                    deleteEventFromStorage(currentDate, currentSlot);
                }
            }

            updateDisplay();
            closeModal();
        }

        function shareEvent(slotKey) {
            const events = getEvents(currentDate);
            const event = events[slotKey];
            if (!event) return;

            const dateStr = formatDateDisplay(currentDate);
            const text = `üìÖ ${event.title}\n‚è∞ ${slotKey} (${event.duration || 60} min)\nüìÜ ${dateStr}${event.description ? '\nüìù ' + event.description : ''}`;

            if (navigator.share) {
                navigator.share({ title: event.title, text });
            } else {
                navigator.clipboard.writeText(text);
                alert('Copiato negli appunti!');
            }
        }

        // Touch swipe handling
        let touchStartY = 0;

        container.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
            isSwiping = false;
            currentDayEl.classList.add('no-transition');
            nextDayEl.classList.add('no-transition');
            prevDayEl.classList.add('no-transition');
        }, { passive: true });

        container.addEventListener('touchmove', (e) => {
            const currentX = e.changedTouches[0].screenX;
            const currentY = e.changedTouches[0].screenY;
            const diffX = currentX - touchStartX;
            const diffY = currentY - touchStartY;

            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 10) {
                isSwiping = true;
                const percentage = Math.max(-1, Math.min(1, diffX / window.innerWidth));
                const currentScale = 1 - Math.abs(percentage) * 0.1;
                const sideScale = 0.9 + Math.abs(percentage) * 0.1;

                currentDayEl.style.transform = `translateX(${percentage * 105}%) scale(${currentScale})`;
                currentDayEl.style.opacity = 1 - Math.abs(percentage) * 0.5;

                if (percentage < 0) {
                    nextDayEl.style.transform = `translateX(${105 + percentage * 105}%) scale(${sideScale})`;
                    nextDayEl.style.opacity = 0.5 + Math.abs(percentage) * 0.5;
                } else {
                    prevDayEl.style.transform = `translateX(${-105 + percentage * 105}%) scale(${sideScale})`;
                    prevDayEl.style.opacity = 0.5 + Math.abs(percentage) * 0.5;
                }

                e.preventDefault();
            }
        }, { passive: false });

        container.addEventListener('touchend', (e) => {
            if (!isSwiping) return;

            touchEndX = e.changedTouches[0].screenX;

            currentDayEl.classList.remove('no-transition');
            nextDayEl.classList.remove('no-transition');
            prevDayEl.classList.remove('no-transition');

            const diff = touchStartX - touchEndX;
            if (Math.abs(diff) > 50) {
                changeDay(diff > 0 ? 1 : -1);
            }

            [currentDayEl, nextDayEl, prevDayEl].forEach(el => {
                el.style.transform = '';
                el.style.opacity = '';
            });

            isSwiping = false;
        });

        // Close modal on background click
        document.getElementById('eventModal').addEventListener('click', (e) => {
            if (e.target.id === 'eventModal') closeModal();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
            if (e.key === 'ArrowLeft' && !document.getElementById('eventModal').classList.contains('show')) changeDay(-1);
            if (e.key === 'ArrowRight' && !document.getElementById('eventModal').classList.contains('show')) changeDay(1);
        });

        // Auto-update time indicator
        setInterval(() => {
            if (isToday(currentDate)) {
                renderDay(currentDate, currentDayEl);
                updateStats();
            }
        }, 60000);

        // Initialize
        updateDisplay();
    </script>
</body>
</html>
