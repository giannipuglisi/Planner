<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2196F3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Planner">
    <meta name="description" content="Organizzatore settimanale con sincronizzazione Google Calendar">
    <title>Organizzatore Settimanale v2.1 - Google Sync</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%232196F3' width='100' height='100' rx='20'/><text x='50' y='65' font-size='50' text-anchor='middle' fill='white'>üìÖ</text></svg>">

    <!-- Google API with onload callbacks -->
    <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
    <script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>

    <style>
        :root {
            --primary: #2196F3;
            --primary-dark: #1976D2;
            --bg-light: #f5f5f5;
            --bg-white: #ffffff;
            --text-dark: #333333;
            --text-muted: #666666;
            --text-light: #999999;
            --border: #e0e0e0;
            --shadow: rgba(0,0,0,0.1);
            --event-bg: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            --event-border: #2196F3;
            --google-blue: #4285F4;
            --google-green: #34A853;
            --cat-work: #2196F3;
            --cat-personal: #9C27B0;
            --cat-health: #4CAF50;
            --cat-meeting: #FF9800;
            --cat-urgent: #f44336;
        }

        .dark-mode {
            --primary: #64B5F6;
            --primary-dark: #42A5F5;
            --bg-light: #1a1a2e;
            --bg-white: #16213e;
            --text-dark: #e0e0e0;
            --text-muted: #b0b0b0;
            --text-light: #808080;
            --border: #2a2a4a;
            --shadow: rgba(0,0,0,0.3);
            --event-bg: linear-gradient(135deg, #1a365d 0%, #2a4a7f 100%);
            --event-border: #64B5F6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            overflow: hidden;
            touch-action: pan-y;
            height: 100vh;
            transition: background 0.3s;
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-logo {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .login-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .login-subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 30px;
        }

        .google-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            color: #333;
            border: none;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }

        .google-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .google-btn:active {
            transform: translateY(0);
        }

        .google-btn svg {
            width: 20px;
            height: 20px;
        }

        .offline-btn {
            margin-top: 16px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.5);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .offline-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 8px 12px 6px 12px;
            text-align: center;
            box-shadow: 0 4px 12px var(--shadow);
            position: relative;
            z-index: 10;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            gap: 6px;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .header-btn:active {
            background: rgba(255,255,255,0.3);
            transform: scale(0.95);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
        }

        .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.5);
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 9px;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(255,255,255,0.2);
        }

        .sync-status.syncing {
            animation: pulse 1s infinite;
        }

        .sync-status.synced {
            background: rgba(76, 175, 80, 0.3);
        }

        .sync-status.offline {
            background: rgba(255, 152, 0, 0.3);
        }

        .sync-status.error {
            background: rgba(244, 67, 54, 0.3);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .date-display {
            font-size: 13px;
            font-weight: bold;
            flex: 1;
            white-space: nowrap;
            overflow: visible;
            text-align: center;
        }

        .days-scroll {
            display: flex;
            overflow-x: auto;
            gap: 4px;
            padding: 4px 0;
            margin: 0 -12px;
            padding-left: 12px;
            padding-right: 12px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .days-scroll::-webkit-scrollbar {
            display: none;
        }

        .day-chip {
            flex-shrink: 0;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 3px 6px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-width: 44px;
        }

        .day-chip.active {
            background: white;
            color: var(--primary);
            border-color: white;
        }

        .day-chip.has-events {
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
        }

        .day-chip.holiday {
            background: rgba(244, 67, 54, 0.8);
            border-color: #f44336;
            color: white;
        }

        .day-chip.holiday.active {
            background: #f44336;
            color: white;
            border-color: #f44336;
        }

        .day-chip:active {
            transform: scale(0.95);
        }

        /* PWA Install Banner */
        .install-banner {
            position: fixed;
            bottom: 50px;
            left: 0;
            right: 0;
            background: var(--bg-white);
            padding: 12px 16px;
            display: none;
            align-items: center;
            gap: 12px;
            box-shadow: 0 -4px 12px var(--shadow);
            z-index: 5000;
        }

        .install-banner.show {
            display: flex;
        }

        .install-banner-text {
            flex: 1;
            font-size: 13px;
            color: var(--text-dark);
        }

        .install-banner-text strong {
            display: block;
            margin-bottom: 2px;
        }

        .install-banner-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .install-banner-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-muted);
            padding: 4px;
        }

        .container {
            position: relative;
            height: calc(100vh - 145px);
            overflow: hidden;
            perspective: 1000px;
        }

        .day-view {
            position: absolute;
            width: 94%;
            left: 3%;
            height: calc(100% - 25px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: transform, opacity;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow);
            background: var(--bg-light);
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            padding: 2px 0;
        }

        .day-view::-webkit-scrollbar {
            width: 4px;
        }

        .day-view::-webkit-scrollbar-track {
            background: transparent;
        }

        .day-view::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 2px;
        }

        .day-view.no-transition {
            transition: none;
        }

        .day-view.left {
            transform: translateX(-105%) scale(0.9);
            opacity: 0.5;
        }

        .day-view.center {
            transform: translateX(0) scale(1);
            opacity: 1;
            z-index: 10;
        }

        .day-view.right {
            transform: translateX(105%) scale(0.9);
            opacity: 0.5;
        }

        .current-time-indicator {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: #f44336;
            z-index: 100;
            pointer-events: none;
        }

        .current-time-indicator::before {
            content: '';
            position: absolute;
            left: 0;
            top: -4px;
            width: 10px;
            height: 10px;
            background: #f44336;
            border-radius: 50%;
        }

        .current-time-indicator::after {
            content: attr(data-time);
            position: absolute;
            right: 4px;
            top: -8px;
            font-size: 9px;
            color: #f44336;
            font-weight: bold;
            background: var(--bg-white);
            padding: 1px 4px;
            border-radius: 4px;
        }

        .swipe-indicator {
            position: fixed;
            bottom: 56px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 4px;
            z-index: 1000;
            pointer-events: none;
            background: var(--bg-white);
            padding: 3px 8px;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .swipe-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: rgba(33, 150, 243, 0.3);
            transition: all 0.3s;
        }

        .swipe-dot.active {
            width: 16px;
            border-radius: 3px;
            background: var(--primary);
        }

        .hour-slot {
            background: var(--bg-white);
            margin: 1px 4px;
            padding: 2px 6px;
            border-radius: 4px;
            box-shadow: 0 1px 2px var(--shadow);
            display: flex;
            align-items: center;
            min-height: 26px;
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
            touch-action: manipulation;
            position: relative;
            border-left: 3px solid transparent;
        }

        .hour-slot:active {
            transform: scale(0.98);
        }

        .hour-slot.half-hour {
            min-height: 22px;
            opacity: 0.9;
        }

        .hour-slot.half-hour .hour-time {
            font-size: 10px;
            color: var(--text-muted);
        }

        .hour-time {
            font-weight: bold;
            font-size: 11px;
            color: var(--primary);
            min-width: 38px;
        }

        .event-content {
            flex: 1;
            margin-left: 6px;
            overflow: hidden;
        }

        .event-title {
            font-weight: 600;
            font-size: 11px;
            color: var(--text-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .event-description {
            font-size: 9px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.1;
        }

        .event-duration {
            font-size: 8px;
            color: var(--text-light);
            margin-left: 4px;
        }

        .event-synced {
            font-size: 10px;
            opacity: 0.6;
        }

        .share-btn {
            background: none;
            border: none;
            font-size: 12px;
            cursor: pointer;
            padding: 2px 4px;
            opacity: 0.6;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .share-btn:active {
            opacity: 1;
            transform: scale(1.2);
        }

        .hour-slot.has-event {
            background: var(--event-bg);
            border-left-color: var(--event-border);
        }

        .hour-slot.cat-work { border-left-color: var(--cat-work); }
        .hour-slot.cat-personal { border-left-color: var(--cat-personal); }
        .hour-slot.cat-health { border-left-color: var(--cat-health); }
        .hour-slot.cat-meeting { border-left-color: var(--cat-meeting); }
        .hour-slot.cat-urgent { border-left-color: var(--cat-urgent); }

        .hour-slot.event-continues {
            background: var(--event-bg);
            opacity: 0.7;
            border-left-style: dashed;
        }

        .hour-slot.from-google {
            border-right: 3px solid var(--google-blue);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.2s;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--bg-white);
            border-radius: 12px;
            padding: 16px;
            width: 92%;
            max-width: 400px;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            color: var(--text-dark);
        }

        .input-group {
            margin-bottom: 10px;
        }

        .input-group label {
            display: block;
            margin-bottom: 4px;
            color: var(--text-muted);
            font-size: 12px;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--bg-white);
            color: var(--text-dark);
        }

        .input-group textarea {
            resize: vertical;
            min-height: 50px;
        }

        .input-row {
            display: flex;
            gap: 8px;
        }

        .input-row .input-group {
            flex: 1;
        }

        .category-picker {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .category-btn {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-btn:hover {
            transform: scale(1.1);
        }

        .category-btn.active {
            border-color: var(--text-dark);
            box-shadow: 0 0 0 2px var(--bg-white);
        }

        .category-btn.cat-work { background: var(--cat-work); }
        .category-btn.cat-personal { background: var(--cat-personal); }
        .category-btn.cat-health { background: var(--cat-health); }
        .category-btn.cat-meeting { background: var(--cat-meeting); }
        .category-btn.cat-urgent { background: var(--cat-urgent); }

        .modal-buttons {
            display: flex;
            gap: 6px;
            margin-top: 12px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:active {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-muted);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .checkbox-group {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-muted);
            cursor: pointer;
        }

        .checkbox-label input {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .empty-state {
            color: var(--text-light);
            font-size: 9px;
        }

        .version-badge {
            font-size: 8px;
            background: rgba(255,255,255,0.2);
            padding: 2px 5px;
            border-radius: 6px;
            margin-left: 6px;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 3px 0;
            font-size: 9px;
            color: rgba(255,255,255,0.8);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            z-index: 4000;
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Bottom Bar */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-white);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 -2px 10px var(--shadow);
            z-index: 1000;
            gap: 10px;
        }

        .bottom-bar-left {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .bottom-bar-user {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .bottom-bar-user img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
        }

        .bottom-bar-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bottom-bar-btn:hover {
            background: var(--primary-dark);
        }

        .bottom-bar-btn.google-btn {
            background: white;
            color: #333;
            border: 1px solid var(--border);
        }

        .bottom-bar-btn.google-btn:hover {
            background: #f5f5f5;
        }

        .bottom-bar-btn svg {
            width: 16px;
            height: 16px;
        }

        .bottom-bar-btn.logout-btn {
            background: var(--bg-light);
            color: var(--text-muted);
        }

        .bottom-bar-status {
            font-size: 11px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
        }

        .status-dot.online {
            background: #4CAF50;
        }

        .status-dot.syncing {
            background: #FF9800;
            animation: pulse 1s infinite;
        }

        .status-dot.error {
            background: #f44336;
        }
    </style>
</head>
<body>
    <!-- Main App -->
    <div class="header">
        <div class="header-top">
            <button class="header-btn" onclick="goToToday()">üìÖ Oggi</button>
            <div class="date-display" id="dateDisplay">
                Caricamento...
                <span class="version-badge">v2.1</span>
            </div>
            <button class="header-btn" onclick="manualSync()" id="syncBtn" style="display:none;">üîÑ</button>
            <button class="header-btn" onclick="toggleDarkMode()">üåô</button>
        </div>
        <div class="stats-bar">
            <div class="stat-item"><span>üìä</span> <span id="todayEvents">0</span> eventi</div>
            <div class="sync-status" id="syncStatus">
                <span>‚è≥</span> <span id="syncText">Offline</span>
            </div>
        </div>
        <div class="days-scroll" id="daysScroll"></div>
    </div>

    <div class="container" id="container">
        <div class="day-view center" id="currentDay"></div>
        <div class="day-view right" id="nextDay"></div>
        <div class="day-view left" id="prevDay"></div>
    </div>

    <div class="swipe-indicator">
        <div class="swipe-dot"></div>
        <div class="swipe-dot active"></div>
        <div class="swipe-dot"></div>
    </div>

    <!-- Bottom Bar with Login/Logout -->
    <div class="bottom-bar" id="bottomBar">
        <div class="bottom-bar-left">
            <!-- Not logged in state -->
            <div id="loginSection">
                <button class="bottom-bar-btn google-btn" onclick="signInWithGoogle()">
                    <svg viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Accedi con Google
                </button>
            </div>
            <!-- Logged in state -->
            <div id="userSection" style="display: none;">
                <div class="bottom-bar-user">
                    <img id="userAvatar" src="" alt="">
                    <span id="userName">Utente</span>
                </div>
            </div>
        </div>
        <div class="bottom-bar-status" id="apiStatus">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Caricamento API...</span>
        </div>
        <div id="logoutSection" style="display: none;">
            <button class="bottom-bar-btn logout-btn" onclick="signOut()">Esci</button>
        </div>
    </div>

    <!-- Event Modal -->
    <div class="modal" id="eventModal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">Aggiungi Evento</div>

            <div class="input-group">
                <label for="eventTitle">Titolo *</label>
                <input type="text" id="eventTitle" placeholder="Es: Riunione di lavoro">
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label for="eventDuration">Durata</label>
                    <select id="eventDuration">
                        <option value="30">30 min</option>
                        <option value="60" selected>1 ora</option>
                        <option value="90">1h 30m</option>
                        <option value="120">2 ore</option>
                        <option value="180">3 ore</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Categoria</label>
                    <div class="category-picker">
                        <button type="button" class="category-btn cat-work active" data-cat="work" title="Lavoro"></button>
                        <button type="button" class="category-btn cat-personal" data-cat="personal" title="Personale"></button>
                        <button type="button" class="category-btn cat-health" data-cat="health" title="Salute"></button>
                        <button type="button" class="category-btn cat-meeting" data-cat="meeting" title="Meeting"></button>
                        <button type="button" class="category-btn cat-urgent" data-cat="urgent" title="Urgente"></button>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label for="eventDescription">Note</label>
                <textarea id="eventDescription" placeholder="Dettagli..."></textarea>
            </div>

            <div class="checkbox-group" id="newEventOptions">
                <label class="checkbox-label">
                    <input type="checkbox" id="syncToGoogle" checked>
                    <span>‚òÅÔ∏è Sincronizza con Google Calendar</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="repeatDaily">
                    <span>üîÅ Ripeti ogni giorno</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="repeatWeekly">
                    <span>üìÜ Ripeti ogni settimana</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="repeatMonthly">
                    <span>üóìÔ∏è Ripeti ogni mese</span>
                </label>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal()">Annulla</button>
                <button class="btn btn-danger" id="deleteBtn" style="display:none;" onclick="deleteEvent()">üóëÔ∏è</button>
                <button class="btn btn-primary" onclick="saveEvent()">üíæ Salva</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- PWA Install Banner -->
    <div class="install-banner" id="installBanner">
        <div class="install-banner-text">
            <strong>üìÖ Installa Planner</strong>
            Aggiungi alla schermata home per accesso rapido
        </div>
        <button class="install-banner-btn" onclick="installPWA()">Installa</button>
        <button class="install-banner-close" onclick="dismissInstallBanner()">√ó</button>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        // IMPORTANT: Replace with your own Google Cloud credentials
        // 1. Go to https://console.cloud.google.com
        // 2. Create a new project or select existing
        // 3. Enable "Google Calendar API"
        // 4. Create OAuth 2.0 credentials (Web application)
        // 5. Add your domain to authorized JavaScript origins
        // 6. Copy the Client ID below

        const GOOGLE_CLIENT_ID = '996979014891-cik6odg0ad64ruugr61g4dk34h1nlh11.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/userinfo.profile';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';

        // ==================== STATE ====================
        let currentDate = new Date();
        let currentSlot = null;
        let selectedCategory = 'work';
        let touchStartX = 0;
        let touchEndX = 0;
        let isSwiping = false;
        let isSignedIn = false;
        let isOfflineMode = false;
        let tokenClient = null;
        let gapiInited = false;
        let gisInited = false;

        // PWA Install prompt
        let deferredPrompt = null;

        // Cache for Google Calendar events
        let googleEventsCache = {};
        let lastSyncTime = null;

        // ==================== ITALIAN HOLIDAYS ====================
        // Fixed holidays (month is 0-indexed)
        const FIXED_HOLIDAYS = [
            { month: 0, day: 1, name: 'Capodanno' },
            { month: 0, day: 6, name: 'Epifania' },
            { month: 3, day: 25, name: 'Festa della Liberazione' },
            { month: 4, day: 1, name: 'Festa dei Lavoratori' },
            { month: 5, day: 2, name: 'Festa della Repubblica' },
            { month: 7, day: 15, name: 'Ferragosto' },
            { month: 10, day: 1, name: 'Tutti i Santi' },
            { month: 11, day: 8, name: 'Immacolata Concezione' },
            { month: 11, day: 25, name: 'Natale' },
            { month: 11, day: 26, name: 'Santo Stefano' }
        ];

        // Calculate Easter and related holidays
        function getEasterDate(year) {
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31) - 1;
            const day = ((h + l - 7 * m + 114) % 31) + 1;
            return new Date(year, month, day);
        }

        function isItalianHoliday(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const day = date.getDate();
            const dayOfWeek = date.getDay();

            // Check fixed holidays
            for (const holiday of FIXED_HOLIDAYS) {
                if (holiday.month === month && holiday.day === day) {
                    return holiday.name;
                }
            }

            // Check Easter and Pasquetta
            const easter = getEasterDate(year);
            if (date.toDateString() === easter.toDateString()) {
                return 'Pasqua';
            }

            const pasquetta = new Date(easter);
            pasquetta.setDate(pasquetta.getDate() + 1);
            if (date.toDateString() === pasquetta.toDateString()) {
                return 'Pasquetta';
            }

            // Sunday is also "festivo"
            if (dayOfWeek === 0) {
                return 'Domenica';
            }

            return null;
        }

        const container = document.getElementById('container');
        const currentDayEl = document.getElementById('currentDay');
        const nextDayEl = document.getElementById('nextDay');
        const prevDayEl = document.getElementById('prevDay');

        // Time slots
        const TIME_SLOTS = [];
        for (let hour = 7; hour <= 21; hour++) {
            TIME_SLOTS.push({ hour, minute: 0 });
            if (hour < 21) TIME_SLOTS.push({ hour, minute: 30 });
        }

        // ==================== GOOGLE AUTH ====================
        function updateApiStatus(status, text) {
            const dot = document.getElementById('statusDot');
            const textEl = document.getElementById('statusText');
            dot.className = 'status-dot ' + status;
            textEl.textContent = text;
        }

        function gapiLoaded() {
            console.log('GAPI loaded');
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    discoveryDocs: [DISCOVERY_DOC],
                });
                gapiInited = true;
                console.log('GAPI client initialized');
                maybeEnableButtons();
            } catch (e) {
                console.error('GAPI init error:', e);
                updateApiStatus('error', 'Errore GAPI');
            }
        }

        function gisLoaded() {
            console.log('GIS loaded');
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: SCOPES,
                    callback: '', // defined later
                });
                gisInited = true;
                console.log('GIS initialized');
                maybeEnableButtons();
            } catch (e) {
                console.error('GIS init error:', e);
                updateApiStatus('error', 'Errore GIS');
            }
        }

        function maybeEnableButtons() {
            // Update status based on API loading
            if (gapiInited && gisInited) {
                updateApiStatus('online', 'Pronto');

                // Check if we have a stored token
                const storedToken = localStorage.getItem('google_token');
                if (storedToken) {
                    try {
                        gapi.client.setToken(JSON.parse(storedToken));
                        handleSignedIn();
                    } catch (e) {
                        console.error('Token restore error:', e);
                        localStorage.removeItem('google_token');
                    }
                }
            } else if (gapiInited || gisInited) {
                updateApiStatus('syncing', 'Caricamento...');
            }
        }

        function signInWithGoogle() {
            if (!gisInited || !gapiInited) {
                showToast('Google API in caricamento...');
                updateApiStatus('error', 'API non pronte');
                return;
            }

            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    console.error('Auth error:', resp.error);
                    showToast('Errore di autenticazione');
                    updateApiStatus('error', 'Errore auth');
                    return;
                }

                // Store token
                localStorage.setItem('google_token', JSON.stringify(gapi.client.getToken()));
                handleSignedIn();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }

        function handleSignedIn() {
            isSignedIn = true;
            isOfflineMode = false;

            // Update bottom bar
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('userSection').style.display = 'block';
            document.getElementById('logoutSection').style.display = 'block';
            document.getElementById('syncBtn').style.display = 'block';

            // Get user info
            fetchUserInfo();

            // Initial sync
            syncWithGoogle();
        }

        async function fetchUserInfo() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: {
                        'Authorization': `Bearer ${gapi.client.getToken().access_token}`
                    }
                });
                const user = await response.json();

                document.getElementById('userAvatar').src = user.picture || '';
                document.getElementById('userName').textContent = user.name || user.email || 'Utente';

                localStorage.setItem('user_info', JSON.stringify(user));
            } catch (e) {
                console.error('Failed to get user info:', e);
            }
        }

        function signOut() {
            try {
                const token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token);
                    gapi.client.setToken('');
                }
            } catch (e) {
                console.error('Sign out error:', e);
            }

            localStorage.removeItem('google_token');
            localStorage.removeItem('user_info');

            isSignedIn = false;

            // Update bottom bar
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('userSection').style.display = 'none';
            document.getElementById('logoutSection').style.display = 'none';
            document.getElementById('syncBtn').style.display = 'none';

            updateSyncStatus('offline');
            updateApiStatus('online', 'Pronto');
            showToast('Disconnesso');
        }

        // ==================== GOOGLE CALENDAR SYNC ====================
        async function syncWithGoogle() {
            if (!isSignedIn) return;

            updateSyncStatus('syncing');
            showLoading(true);

            try {
                // Get events for 2 years
                const startDate = new Date();
                startDate.setMonth(startDate.getMonth() - 1); // 1 month back
                const endDate = new Date();
                endDate.setFullYear(endDate.getFullYear() + 2); // 2 years forward

                const response = await gapi.client.calendar.events.list({
                    'calendarId': 'primary',
                    'timeMin': startDate.toISOString(),
                    'timeMax': endDate.toISOString(),
                    'showDeleted': false,
                    'singleEvents': true,
                    'orderBy': 'startTime'
                });

                const events = response.result.items || [];

                // Process events
                googleEventsCache = {};
                events.forEach(event => {
                    if (event.start.dateTime) {
                        const start = new Date(event.start.dateTime);
                        const dateKey = formatDate(start);
                        const slotKey = getSlotKey(start.getHours(), Math.floor(start.getMinutes() / 30) * 30);

                        if (!googleEventsCache[dateKey]) {
                            googleEventsCache[dateKey] = {};
                        }

                        // Calculate duration
                        const end = new Date(event.end.dateTime);
                        const duration = Math.round((end - start) / 60000);

                        googleEventsCache[dateKey][slotKey] = {
                            title: event.summary || 'Evento',
                            description: event.description || '',
                            duration: duration,
                            category: getCategoryFromColor(event.colorId),
                            googleEventId: event.id,
                            fromGoogle: true
                        };
                    }
                });

                lastSyncTime = new Date();
                updateSyncStatus('synced');
                showToast('Sincronizzazione completata');
                updateDisplay();

            } catch (e) {
                console.error('Sync error:', e);
                updateSyncStatus('error');

                if (e.status === 401) {
                    // Token expired
                    signOut();
                    showToast('Sessione scaduta, accedi di nuovo');
                } else {
                    showToast('Errore di sincronizzazione');
                }
            }

            showLoading(false);
        }

        async function createGoogleEvent(date, slotKey, eventData) {
            if (!isSignedIn) return null;

            const [hour, minute] = slotKey.split(':').map(Number);
            const startDate = new Date(date);
            startDate.setHours(hour, minute, 0, 0);

            const endDate = new Date(startDate);
            endDate.setMinutes(endDate.getMinutes() + (eventData.duration || 60));

            const event = {
                'summary': eventData.title,
                'description': eventData.description || '',
                'start': {
                    'dateTime': startDate.toISOString(),
                    'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone
                },
                'end': {
                    'dateTime': endDate.toISOString(),
                    'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone
                },
                'colorId': getColorFromCategory(eventData.category)
            };

            // Add recurrence if needed
            if (eventData.repeatDaily) {
                event.recurrence = ['RRULE:FREQ=DAILY'];
            } else if (eventData.repeatWeekly) {
                event.recurrence = ['RRULE:FREQ=WEEKLY'];
            } else if (eventData.repeatMonthly) {
                event.recurrence = ['RRULE:FREQ=MONTHLY'];
            }

            try {
                const response = await gapi.client.calendar.events.insert({
                    'calendarId': 'primary',
                    'resource': event
                });
                return response.result.id;
            } catch (e) {
                console.error('Failed to create event:', e);
                return null;
            }
        }

        async function deleteGoogleEvent(googleEventId) {
            if (!isSignedIn || !googleEventId) return;

            try {
                await gapi.client.calendar.events.delete({
                    'calendarId': 'primary',
                    'eventId': googleEventId
                });
            } catch (e) {
                console.error('Failed to delete event:', e);
            }
        }

        function manualSync() {
            syncWithGoogle();
        }

        // Color mapping
        function getColorFromCategory(category) {
            const colorMap = {
                'work': '9',      // Blue
                'personal': '3',  // Purple
                'health': '10',   // Green
                'meeting': '5',   // Yellow
                'urgent': '11'    // Red
            };
            return colorMap[category] || '9';
        }

        function getCategoryFromColor(colorId) {
            const categoryMap = {
                '9': 'work',
                '3': 'personal',
                '10': 'health',
                '5': 'meeting',
                '11': 'urgent'
            };
            return categoryMap[colorId] || 'work';
        }

        // ==================== LOCAL STORAGE ====================
        function getSlotKey(hour, minute) {
            return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
        }

        function getEvents(date) {
            const dateKey = formatDate(date);

            // Get local events
            const stored = localStorage.getItem(`events_${dateKey}`);
            const localEvents = stored ? JSON.parse(stored) : {};

            // Merge with Google events
            const googleEvents = googleEventsCache[dateKey] || {};

            // Google events take precedence for synced items
            return { ...localEvents, ...googleEvents };
        }

        function saveEventLocally(date, slotKey, event) {
            const dateKey = formatDate(date);
            const events = {};
            const stored = localStorage.getItem(`events_${dateKey}`);
            if (stored) Object.assign(events, JSON.parse(stored));
            events[slotKey] = event;
            localStorage.setItem(`events_${dateKey}`, JSON.stringify(events));
        }

        function deleteEventLocally(date, slotKey) {
            const dateKey = formatDate(date);
            const stored = localStorage.getItem(`events_${dateKey}`);
            if (stored) {
                const events = JSON.parse(stored);
                delete events[slotKey];
                localStorage.setItem(`events_${dateKey}`, JSON.stringify(events));
            }
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function formatDateDisplay(date) {
            const options = { weekday: 'short', day: 'numeric', month: 'short' };
            return date.toLocaleDateString('it-IT', options);
        }

        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        // ==================== UI ====================
        function updateSyncStatus(status) {
            const statusEl = document.getElementById('syncStatus');
            const textEl = document.getElementById('syncText');

            statusEl.className = 'sync-status ' + status;

            const statusTexts = {
                'syncing': 'üîÑ Sincronizzazione...',
                'synced': '‚úÖ Sincronizzato',
                'offline': 'üì¥ Offline',
                'error': '‚ùå Errore'
            };

            textEl.textContent = statusTexts[status] || 'Offline';
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('show', show);
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }

        // Category picker
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedCategory = btn.dataset.cat;
            });
        });

        function renderDay(date, container) {
            const events = getEvents(date);
            let html = '';
            const now = new Date();
            const showTimeIndicator = isToday(date);

            // Calculate continuations
            const continuationSlots = {};
            for (let slotKey in events) {
                const event = events[slotKey];
                if (event && event.duration > 30) {
                    const [h, m] = slotKey.split(':').map(Number);
                    let slots = Math.floor(event.duration / 30) - 1;
                    let currentH = h;
                    let currentM = m;

                    for (let i = 0; i < slots; i++) {
                        currentM += 30;
                        if (currentM >= 60) { currentM = 0; currentH++; }
                        continuationSlots[getSlotKey(currentH, currentM)] = { event };
                    }
                }
            }

            TIME_SLOTS.forEach(slot => {
                const slotKey = getSlotKey(slot.hour, slot.minute);
                const event = events[slotKey];
                const continuation = continuationSlots[slotKey];
                const hasEvent = event && event.title;
                const isHalfHour = slot.minute === 30;

                let timeIndicator = '';
                if (showTimeIndicator) {
                    const slotStart = slot.hour * 60 + slot.minute;
                    const slotEnd = slotStart + 30;
                    const currentMinutes = now.getHours() * 60 + now.getMinutes();

                    if (currentMinutes >= slotStart && currentMinutes < slotEnd) {
                        const offset = ((currentMinutes - slotStart) / 30) * 100;
                        const timeNow = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
                        timeIndicator = `<div class="current-time-indicator" style="top: ${offset}%;" data-time="${timeNow}"></div>`;
                    }
                }

                let slotClasses = `hour-slot ${isHalfHour ? 'half-hour' : ''}`;
                let content = '';

                if (continuation) {
                    slotClasses += ` event-continues cat-${continuation.event.category || 'work'}`;
                    content = `<div class="event-content"><div class="event-title" style="opacity:0.5">‚Ü≥ ${continuation.event.title}</div></div>`;
                } else if (hasEvent) {
                    slotClasses += ` has-event cat-${event.category || 'work'}`;
                    if (event.fromGoogle) slotClasses += ' from-google';

                    content = `
                        <div class="event-content">
                            <div class="event-title">
                                ${event.fromGoogle ? '‚òÅÔ∏è ' : ''}${event.title}
                                ${event.duration > 30 ? `<span class="event-duration">${event.duration}m</span>` : ''}
                            </div>
                            ${event.description ? `<div class="event-description">${event.description}</div>` : ''}
                        </div>
                        <button class="share-btn" onclick="event.stopPropagation(); shareEvent('${slotKey}')">üì§</button>
                    `;
                } else {
                    content = `<div class="event-content"><div class="empty-state">‚Äî</div></div>`;
                }

                html += `
                    <div class="${slotClasses}" onclick="openModal('${slotKey}')" style="position:relative;">
                        ${timeIndicator}
                        <div class="hour-time">${slotKey}</div>
                        ${content}
                    </div>
                `;
            });

            container.innerHTML = html;

            if (showTimeIndicator) {
                setTimeout(() => {
                    const indicator = container.querySelector('.current-time-indicator');
                    if (indicator) indicator.parentElement.scrollIntoView({ block: 'center', behavior: 'smooth' });
                }, 100);
            }
        }

        function updateDisplay() {
            document.getElementById('dateDisplay').innerHTML = formatDateDisplay(currentDate) + '<span class="version-badge">v2.1</span>';

            renderDay(currentDate, currentDayEl);

            const nextDate = new Date(currentDate);
            nextDate.setDate(nextDate.getDate() + 1);
            renderDay(nextDate, nextDayEl);

            const prevDate = new Date(currentDate);
            prevDate.setDate(prevDate.getDate() - 1);
            renderDay(prevDate, prevDayEl);

            renderDaysScroll();
            updateStats();
        }

        function updateStats() {
            const events = getEvents(currentDate);
            const eventCount = Object.values(events).filter(e => e && e.title).length;
            document.getElementById('todayEvents').textContent = eventCount;
        }

        function renderDaysScroll() {
            const scrollContainer = document.getElementById('daysScroll');
            let html = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = -30; i < 730; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);

                const dayName = date.toLocaleDateString('it-IT', { weekday: 'short' });
                const dayNum = date.getDate();

                const currentNorm = new Date(currentDate);
                currentNorm.setHours(0, 0, 0, 0);
                const isActive = date.getTime() === currentNorm.getTime();

                const dayEvents = getEvents(date);
                const hasEvents = Object.values(dayEvents).some(e => e && e.title);

                const holidayName = isItalianHoliday(date);
                const isHoliday = holidayName !== null;

                html += `
                    <div class="day-chip ${isActive ? 'active' : ''} ${hasEvents ? 'has-events' : ''} ${isHoliday ? 'holiday' : ''}"
                         onclick="jumpToDate('${date.toISOString()}')"
                         ${isHoliday ? `title="${holidayName}"` : ''}>
                        <div style="font-size: 8px; opacity: 0.8;">${dayName}</div>
                        <div style="font-weight: 700;">${dayNum}</div>
                    </div>
                `;
            }

            scrollContainer.innerHTML = html;

            setTimeout(() => {
                const activeChip = scrollContainer.querySelector('.day-chip.active');
                if (activeChip) activeChip.scrollIntoView({ inline: 'center', behavior: 'smooth' });
            }, 100);
        }

        function jumpToDate(isoDate) {
            currentDate = new Date(isoDate);
            updateDisplay();
        }

        function goToToday() {
            currentDate = new Date();
            updateDisplay();
        }

        function changeDay(offset) {
            currentDate.setDate(currentDate.getDate() + offset);
            updateDisplay();
        }

        // ==================== MODAL ====================
        function openModal(slotKey) {
            currentSlot = slotKey;
            const events = getEvents(currentDate);
            const event = events[slotKey];

            document.getElementById('modalTitle').textContent = event ? 'Modifica Evento' : 'Nuovo Evento ' + slotKey;
            document.getElementById('eventTitle').value = event ? event.title : '';
            document.getElementById('eventDescription').value = event ? (event.description || '') : '';
            document.getElementById('eventDuration').value = event ? (event.duration || 60) : 60;

            selectedCategory = event ? (event.category || 'work') : 'work';
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.cat === selectedCategory);
            });

            document.getElementById('deleteBtn').style.display = event ? 'block' : 'none';
            document.getElementById('newEventOptions').style.display = event ? 'none' : 'block';

            document.getElementById('syncToGoogle').checked = isSignedIn;
            document.getElementById('repeatDaily').checked = false;
            document.getElementById('repeatWeekly').checked = false;
            document.getElementById('repeatMonthly').checked = false;

            document.getElementById('eventModal').classList.add('show');
            document.getElementById('eventTitle').focus();
        }

        function closeModal() {
            document.getElementById('eventModal').classList.remove('show');
            currentSlot = null;
        }

        async function saveEvent() {
            const title = document.getElementById('eventTitle').value.trim();
            if (!title) {
                showToast('Inserisci un titolo');
                return;
            }

            const description = document.getElementById('eventDescription').value.trim();
            const duration = parseInt(document.getElementById('eventDuration').value);
            const syncToGoogle = document.getElementById('syncToGoogle').checked && isSignedIn;
            const repeatDaily = document.getElementById('repeatDaily').checked;
            const repeatWeekly = document.getElementById('repeatWeekly').checked;
            const repeatMonthly = document.getElementById('repeatMonthly').checked;

            const eventData = {
                title,
                description,
                duration,
                category: selectedCategory,
                repeatDaily,
                repeatWeekly,
                repeatMonthly
            };

            // Save locally
            saveEventLocally(currentDate, currentSlot, eventData);

            // Sync to Google if requested
            if (syncToGoogle) {
                showLoading(true);
                const googleId = await createGoogleEvent(currentDate, currentSlot, eventData);
                if (googleId) {
                    eventData.googleEventId = googleId;
                    eventData.fromGoogle = true;
                    saveEventLocally(currentDate, currentSlot, eventData);
                    showToast('Evento sincronizzato con Google');
                } else {
                    showToast('Salvato localmente');
                }
                showLoading(false);
            }

            updateDisplay();
            closeModal();
        }

        async function deleteEvent() {
            const events = getEvents(currentDate);
            const event = events[currentSlot];

            if (confirm('Eliminare questo evento?')) {
                // Delete from Google if synced
                if (event && event.googleEventId && isSignedIn) {
                    showLoading(true);
                    await deleteGoogleEvent(event.googleEventId);
                    showLoading(false);
                }

                deleteEventLocally(currentDate, currentSlot);

                // Remove from cache
                const dateKey = formatDate(currentDate);
                if (googleEventsCache[dateKey]) {
                    delete googleEventsCache[dateKey][currentSlot];
                }

                showToast('Evento eliminato');
                updateDisplay();
                closeModal();
            }
        }

        function shareEvent(slotKey) {
            const events = getEvents(currentDate);
            const event = events[slotKey];
            if (!event) return;

            const text = `üìÖ ${event.title}\n‚è∞ ${slotKey} (${event.duration || 60}min)\nüìÜ ${formatDateDisplay(currentDate)}${event.description ? '\nüìù ' + event.description : ''}`;

            if (navigator.share) {
                navigator.share({ title: event.title, text });
            } else {
                navigator.clipboard.writeText(text);
                showToast('Copiato!');
            }
        }

        // ==================== TOUCH HANDLING ====================
        let touchStartY = 0;

        container.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
            isSwiping = false;
            currentDayEl.classList.add('no-transition');
            nextDayEl.classList.add('no-transition');
            prevDayEl.classList.add('no-transition');
        }, { passive: true });

        container.addEventListener('touchmove', (e) => {
            const currentX = e.changedTouches[0].screenX;
            const currentY = e.changedTouches[0].screenY;
            const diffX = currentX - touchStartX;
            const diffY = currentY - touchStartY;

            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 10) {
                isSwiping = true;
                const percentage = Math.max(-1, Math.min(1, diffX / window.innerWidth));
                const currentScale = 1 - Math.abs(percentage) * 0.1;
                const sideScale = 0.9 + Math.abs(percentage) * 0.1;

                currentDayEl.style.transform = `translateX(${percentage * 105}%) scale(${currentScale})`;
                currentDayEl.style.opacity = 1 - Math.abs(percentage) * 0.5;

                if (percentage < 0) {
                    nextDayEl.style.transform = `translateX(${105 + percentage * 105}%) scale(${sideScale})`;
                    nextDayEl.style.opacity = 0.5 + Math.abs(percentage) * 0.5;
                } else {
                    prevDayEl.style.transform = `translateX(${-105 + percentage * 105}%) scale(${sideScale})`;
                    prevDayEl.style.opacity = 0.5 + Math.abs(percentage) * 0.5;
                }

                e.preventDefault();
            }
        }, { passive: false });

        container.addEventListener('touchend', (e) => {
            if (!isSwiping) return;

            touchEndX = e.changedTouches[0].screenX;

            currentDayEl.classList.remove('no-transition');
            nextDayEl.classList.remove('no-transition');
            prevDayEl.classList.remove('no-transition');

            const diff = touchStartX - touchEndX;
            if (Math.abs(diff) > 50) changeDay(diff > 0 ? 1 : -1);

            [currentDayEl, nextDayEl, prevDayEl].forEach(el => {
                el.style.transform = '';
                el.style.opacity = '';
            });

            isSwiping = false;
        });

        // Close modal on background click
        document.getElementById('eventModal').addEventListener('click', (e) => {
            if (e.target.id === 'eventModal') closeModal();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
            if (e.key === 'ArrowLeft' && !document.getElementById('eventModal').classList.contains('show')) changeDay(-1);
            if (e.key === 'ArrowRight' && !document.getElementById('eventModal').classList.contains('show')) changeDay(1);
        });

        // Auto-sync every 5 minutes
        setInterval(() => {
            if (isSignedIn) syncWithGoogle();
        }, 300000);

        // Auto-update time indicator
        setInterval(() => {
            if (isToday(currentDate)) {
                renderDay(currentDate, currentDayEl);
            }
        }, 60000);

        // ==================== PWA INSTALL ====================
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Show install banner if not dismissed before
            if (!localStorage.getItem('pwa_install_dismissed')) {
                setTimeout(() => {
                    document.getElementById('installBanner').classList.add('show');
                }, 3000);
            }
        });

        function installPWA() {
            if (!deferredPrompt) {
                showToast('App gi√† installata o non supportata');
                return;
            }

            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    showToast('App installata!');
                }
                deferredPrompt = null;
                document.getElementById('installBanner').classList.remove('show');
            });
        }

        function dismissInstallBanner() {
            document.getElementById('installBanner').classList.remove('show');
            localStorage.setItem('pwa_install_dismissed', 'true');
        }

        // Detect if running as PWA
        window.addEventListener('appinstalled', () => {
            showToast('App installata con successo!');
            document.getElementById('installBanner').classList.remove('show');
        });

        // ==================== INIT ====================
        // Load APIs
        window.onload = () => {
            updateDisplay();

            // Register Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            }

            // Set timeout for API loading
            setTimeout(() => {
                if (!gapiInited || !gisInited) {
                    console.warn('Google APIs not loaded after timeout');
                    updateApiStatus('error', 'API non caricate');
                }
            }, 10000);

            // Try to initialize APIs if they loaded before onload
            if (typeof gapi !== 'undefined' && !gapiInited) {
                gapiLoaded();
            }
            if (typeof google !== 'undefined' && google.accounts && !gisInited) {
                gisLoaded();
            }
        };

        // Expose functions globally for script onload
        window.gapiLoaded = gapiLoaded;
        window.gisLoaded = gisLoaded;
    </script>
</body>
</html>
